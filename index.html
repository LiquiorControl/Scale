<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro 6.0 (Industrial)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- TEMA INDUSTRIAL 6.0 --- */
        :root { 
            --font-head: 'Anton', sans-serif;
            --font-body: 'Roboto', sans-serif;
            --color-premium: #d4a035; --color-wells: #666666; --color-seltzer: #00bfb3;
            --color-beers: #e87722; --color-wines: #a31818; --color-nonalc: #d1d5db;
            --color-scan: #00dcd2; --bg-body: #000000; --text-main: #ffffff;
        }
        
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-body); min-height: 100vh; overscroll-behavior-y: none; -webkit-font-smoothing: antialiased; }
        h1, h2, h3, .impact-text { font-family: var(--font-head); text-transform: uppercase; letter-spacing: 1px; }
        
        /* CLASE PARA DEJAR FIJO EL ENCABEZADO */
        .sticky-header-industrial {
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: #000000;
            border-bottom: 4px solid white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.8);
        }

        .search-industrial { background-color: #bbbbbb; border: 2px solid white; color: black; font-family: var(--font-body); font-weight: bold; border-radius: 0; }
        .search-industrial::placeholder { color: #555; }
        .cat-block { width: 100%; padding: 1rem; text-align: left; margin-bottom: 0.8rem; font-family: var(--font-head); font-size: 1.8rem; line-height: 1; color: white; border: none; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 4px 0 rgba(0,0,0,0.5); }
        .cat-sub { background-color: black; color: white; font-family: var(--font-head); font-size: 1.2rem; padding: 0.2rem 0.5rem; margin-top: 0.5rem; display: inline-block; width: fit-content; }
        .modal-industrial { background-color: #111; border: 4px solid white; color: white; }
        #reader { border: 4px solid var(--color-scan) !important; background: #000; }
        .bg-premium { background-color: var(--color-premium); } .bg-wells { background-color: var(--color-wells); } .bg-seltzer { background-color: var(--color-seltzer); } .bg-beers { background-color: var(--color-beers); } .bg-wines { background-color: var(--color-wines); } .bg-nonalc { background-color: var(--color-nonalc); color: black !important; }
        .menu-backdrop { position: fixed; inset: 0; z-index: 45; background: rgba(255,255,255, 0.1); backdrop-filter: blur(2px); }
        .animate-in { animation: slideUp 0.2s ease-out; } @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        window.fb = { initializeApp, getFirestore, doc, onSnapshot, setDoc, getAuth, signInAnonymously, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const FIREBASE_CONFIG = { apiKey: "AIzaSyDqdJcKILp5kQ4sTxVm8Ch5E7oXfMD3BAM", authDomain: "master-control-palmas.firebaseapp.com", projectId: "master-control-palmas", storageBucket: "master-control-palmas.firebasestorage.app", messagingSenderId: "681752784684", appId: "1:681752784684:web:e4a4a4ce96d587380d4689" };
        
        const ZONES_CONFIG = {
            bar1: [ { id: 'bar1_cooler', label: 'Cooler Beer', icon: 'ðŸ§Š' }, { id: 'bar1_small_cooler_1', label: 'Small 1', icon: 'â„ï¸' }, { id: 'bar1_small_cooler_2', label: 'Small 2', icon: 'â„ï¸' }, { id: 'bar1_reaching', label: 'Reaching', icon: 'âœ‹' }, { id: 'bar1_shelf_full', label: 'Shelf Full', icon: 'ðŸ¾' }, { id: 'bar1_shelf_open', label: 'Shelf Open', icon: 'ðŸ¥ƒ' }, { id: 'bar1_well_1', label: 'Well 1', icon: 'ðŸ¥ƒ' }, { id: 'bar1_well_2', label: 'Well 2', icon: 'ðŸ¥ƒ' } ],
            bar2: [ { id: 'bar2_cooler', label: 'Cooler', icon: 'ðŸ§Š' }, { id: 'bar2_small_cooler', label: 'Small Cooler', icon: 'â„ï¸' } ],
            bodega: [ { id: 'bodega_closet', label: 'Closet', icon: 'ðŸšª' }, { id: 'bodega_shelves', label: 'Shelves', icon: 'ðŸ—„ï¸' } ]
        };
        const playSound = (type) => {
            try { const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return; const ctx = new AudioContext(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); const now = ctx.currentTime;
                if (type === 'success') { osc.type = "square"; osc.frequency.setValueAtTime(440, now); osc.frequency.linearRampToValueAtTime(880, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
                if (type === 'error') { osc.type = "sawtooth"; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
                if (type === 'add') { osc.type = "triangle"; osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); }
                if (type === 'sub') { osc.type = "square"; osc.frequency.setValueAtTime(200, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.05); osc.start(now); osc.stop(now + 0.05); }
                if (type === 'blip') { osc.type = "sine"; osc.frequency.setValueAtTime(1200, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.03); osc.start(now); osc.stop(now + 0.03); }
                if (type === 'connect') { osc.type = "square"; osc.frequency.setValueAtTime(220, now); osc.frequency.linearRampToValueAtTime(440, now + 0.2); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.2); osc.start(now); osc.stop(now + 0.2); }
            } catch (e) {}
        };

        const IconWrapper = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="square" strokeLinejoin="miter" className={className}>{children}</svg>);
        const Icons = {
            Scan: (p) => <IconWrapper {...p}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="10" height="6" x="7" y="9" rx="1"/></IconWrapper>,
            Search: (p) => <IconWrapper {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconWrapper>,
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            Beer: (p) => <IconWrapper {...p}><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12h6"/><path d="M9 12v3a8 8 0 0 1-16 0v-3"/><path d="M22 6h-7a2 2 0 0 0-2 2v2"/><path d="M5 12V3a2 2 0 0 1 2-2h7"/></IconWrapper>,
            Box: (p) => <IconWrapper {...p}><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Wine: (p) => <IconWrapper {...p}><path d="M8 22h8"/><path d="M7 10h10"/><path d="M12 15v7"/><path d="M12 15a5 5 0 0 0 5-5c0-2-.5-4-2-8H9c-1.5 4-2 6-2 8a5 5 0 0 0 5 5Z"/></IconWrapper>,
            ChevronDown: (p) => <IconWrapper {...p}><path d="m6 9 6 6 6-6"/></IconWrapper>,
            List: (p) => <IconWrapper {...p}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></IconWrapper>,
            Link: (p) => <IconWrapper {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></IconWrapper>,
            Save: (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>,
            Star: (p) => <IconWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconWrapper>,
            Package: (p) => <IconWrapper {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconWrapper>,
            Barcode: (p) => <IconWrapper {...p}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></IconWrapper>,
            ShoppingCart: (p) => <IconWrapper {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconWrapper>,
            Settings: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></IconWrapper>,
            Scale: (p) => <IconWrapper {...p}><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M12 9v3"/></IconWrapper>,
            Wrench: (p) => <IconWrapper {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></IconWrapper>,
            Refresh: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 21H3v-5"/></IconWrapper>,
            Reset: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>,
            Upload: (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconWrapper>,
            Bluetooth: (p) => <IconWrapper {...p}><path d="m7 7 10 10-5 5V2l5 5L7 17"/></IconWrapper>
        };

        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState("");
            const handlePress = (n) => { playSound('blip'); const newP = pin + n; setPin(newP); if (newP === "1130") { playSound('success'); onLogin(); } if (newP.length >= 4 && newP !== "1130") { playSound('error'); setPin(""); } };
            return ( <div className="fixed inset-0 flex flex-col items-center justify-center p-4 z-50 bg-black"> <div className="modal-industrial w-full max-w-sm p-8 shadow-[10px_10px_0px_0px_rgba(50,50,50,1)]"> <div className="mb-8 text-center"> <h1 className="text-5xl text-white uppercase tracking-tighter" style={{fontFamily: 'Anton'}}>SYSTEM<br/>ACCESS</h1> <div className="h-2 w-full bg-premium mt-2"></div> </div> <div className="flex justify-center gap-4 mb-8">{[0,1,2,3].map(i=><div key={i} className={`w-4 h-4 border-2 border-white transition-all duration-0 ${pin.length>i?'bg-white':'bg-transparent'}`}></div>)}</div> <div className="grid grid-cols-3 gap-4">{[1,2,3,4,5,6,7,8,9,0].map(n=><button key={n} onClick={() => handlePress(n)} className={`h-20 w-20 border-4 border-white text-3xl font-black text-white hover:bg-white hover:text-black transition-colors duration-0 ${n===0?'col-start-2':''}`} style={{fontFamily: 'Anton'}}>{n}</button>)}</div> </div> </div> );
        };

        const ScannerModal = ({ onScan, onClose }) => {
            useEffect(() => { const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: { width: 250, height: 250 } }, false); scanner.render(onScan, (e)=>{}); return () => scanner.clear().catch(()=>{}); }, []);
            return ( <div className="fixed inset-0 bg-black z-40 flex flex-col"> <div className="p-4 border-b-4 border-[#00dcd2] flex justify-between items-center relative z-10 bg-black"> <h2 className="text-[#00dcd2] font-black tracking-widest flex items-center gap-2 uppercase text-xl" style={{fontFamily: 'Anton'}}><div className="w-4 h-4 bg-[#00dcd2]"></div> OPTICAL SENSOR</h2> <button onClick={onClose} className="text-white font-bold border-2 border-white px-4 py-1 hover:bg-red-600 hover:border-red-600 uppercase transition-colors duration-0">STOP</button> </div> <div className="flex-1 flex items-center justify-center p-4 relative"> <div id="reader" className="w-full max-w-sm border-4 border-[#00dcd2] bg-black shadow-[0_0_50px_rgba(0,220,210,0.2)]"></div> </div> </div> );
        };

        const LocationModal = ({ onClose, onSelect }) => {
            const locs = [ {id:'bar1',l:'BAR 1',i:Icons.Beer, c: 'text-white'}, {id:'bar2',l:'BAR 2',i:Icons.Wine, c: 'text-white'}, {id:'bodega',l:'BODEGA',i:Icons.Box, c: 'text-white'}, {id:'barroluco',l:'BARROLUCO',i:Icons.MapPin, c: 'text-white'}, {id:'purchases',l:'PURCHASES',i:Icons.ShoppingCart, c: 'text-white'} ];
            const [selMain, setSelMain] = useState(null);
            const subZones = selMain ? (ZONES_CONFIG[selMain] || []) : [];
            return ( <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-in bg-black/95"> <div className="w-full max-w-lg border-4 border-white bg-black shadow-[10px_10px_0px_0px_#333]"> <div className="p-4 border-b-4 border-white flex justify-between items-center"><h2 className="text-3xl font-black text-white uppercase tracking-tight" style={{fontFamily: 'Anton'}}>{selMain ? 'SELECT SUB-ZONE' : 'SELECT SECTOR'}</h2><button onClick={onClose} className="text-white font-bold border-2 border-white px-4 py-1 hover:bg-white hover:text-black uppercase transition-colors duration-0">CANCEL</button></div> <div className="p-4 overflow-y-auto grid grid-cols-1 gap-4"> {!selMain ? locs.map(l=><button key={l.id} onClick={()=>{if(ZONES_CONFIG[l.id]) setSelMain(l.id); else onSelect(l.id, null);}} className="bg-[#111] border-2 border-white text-white p-6 flex items-center gap-4 hover:bg-white hover:text-black transition-colors duration-0 group"><l.i className="w-8 h-8"/><span className="font-black text-2xl tracking-wide uppercase" style={{fontFamily: 'Anton'}}>{l.l}</span></button>) : subZones.map(z=><button key={z.id} onClick={()=>onSelect(selMain, z.id)} className="bg-[#111] border-2 border-white text-white p-4 flex items-center gap-4 hover:bg-white hover:text-black transition-colors duration-0 group"><span className="text-2xl">{z.icon}</span><span className="font-bold text-xl uppercase tracking-wide" style={{fontFamily: 'Anton'}}>{z.label}</span></button>)} {selMain && subZones.length === 0 && (<div className="text-center py-8"><button onClick={()=>onSelect(selMain, null)} className="text-white border-b-2 border-white font-bold text-xl hover:bg-white hover:text-black">SELECT ENTIRE SECTOR</button></div>)} </div> </div> </div> );
        };
        const PurchasesLogModal = ({ onClose, data }) => {
            const purchasedItems = []; let totalPurchasedUnits = 0;
            data.forEach(cat => { cat.items.forEach(item => { const val = parseFloat(item.purchases); if (!isNaN(val) && val > 0) { purchasedItems.push({ ...item, categoryName: cat.category, purchaseVal: val }); totalPurchasedUnits += val; } }); });
            return ( <div className="fixed inset-0 z-[80] flex flex-col bg-black/90 backdrop-blur-sm animate-in overflow-hidden"> <div className="bg-premium p-4 border-b-4 border-white flex justify-between items-center shadow-md"> <h2 className="text-3xl font-black text-black uppercase tracking-tight" style={{fontFamily: 'Anton'}}>INBOUND LOG</h2> <button onClick={onClose} className="px-6 py-2 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-bold uppercase tracking-widest text-sm transition-colors duration-0">CLOSE</button> </div> <div className="flex-1 overflow-y-auto p-4 bg-black"> {purchasedItems.length === 0 ? <div className="text-center text-gray-500 mt-20 font-bold text-2xl uppercase tracking-widest">NO DATA LOGGED</div> : <div className="space-y-4"><div className="bg-black border-4 border-white p-6 flex flex-col items-center"><div className="text-sm text-premium uppercase font-black tracking-[0.3em] mb-1">SESSION TOTAL</div><div className="text-6xl font-black text-white" style={{fontFamily: 'Anton'}}>{totalPurchasedUnits}</div></div><div className="grid gap-2">{purchasedItems.map((item, idx) => (<div key={idx} className="bg-[#111] border-2 border-[#333] p-4 flex justify-between items-center hover:border-premium transition-colors duration-0"><div><div className="font-bold text-white text-xl uppercase">{item.name}</div><div className="text-xs text-gray-400 font-bold bg-gray-800 px-2 py-0.5 inline-block mt-1">{item.categoryName}</div></div><div className="text-premium font-black text-3xl" style={{fontFamily: 'Anton'}}>+{item.purchaseVal}</div></div>))}</div></div>} </div> </div> );
        };

        const PremiumControlModal = ({ onClose, data, onUpdateStickers }) => {
            const premiumCategory = data.find(cat => cat.category.includes("Premium"));
            const items = premiumCategory ? premiumCategory.items : [];
            const [searchTerm, setSearchTerm] = useState("");
            const [inputs, setInputs] = useState({});
            const handleInputChange = (itemId, val) => { setInputs(prev => ({ ...prev, [itemId]: val })); };
            const handleAddSticker = (item) => { const newSticker = inputs[item.id]; if (!newSticker || !newSticker.trim()) return; const currentStickers = item.sticker_ids || []; if (currentStickers.includes(newSticker.trim())) { playSound('error'); return; } const newArray = [...currentStickers, newSticker.trim()]; onUpdateStickers(item.id, newArray); setInputs(prev => ({ ...prev, [item.id]: "" })); playSound('add'); };
            const handleRemoveSticker = (item, stickerToRemove) => { const currentStickers = item.sticker_ids || []; const newArray = currentStickers.filter(s => s !== stickerToRemove); onUpdateStickers(item.id, newArray); playSound('sub'); };
            const filteredItems = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));
            return ( <div className="fixed inset-0 z-[90] flex flex-col bg-black animate-in overflow-hidden"> <div className="bg-premium p-4 border-b-4 border-white flex justify-between items-center"><div><h2 className="text-3xl font-black text-black uppercase tracking-tight" style={{fontFamily: 'Anton'}}>BOTTLE CONTROL</h2></div><button onClick={onClose} className="px-6 py-2 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-bold uppercase tracking-widest text-sm transition-colors duration-0">CLOSE</button></div> <div className="p-4 bg-black border-b-2 border-[#333]"><div className="relative"><input type="text" placeholder="SEARCH BOTTLE..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full search-industrial p-4 text-xl uppercase placeholder-gray-600 focus:outline-none focus:border-premium" /></div></div> <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-black">{filteredItems.map(item => { const stickers = item.sticker_ids || []; return (<div key={item.id} className="border-4 border-[#333] p-4 bg-[#0a0a0a]"><div className="flex justify-between items-start mb-3"><h3 className="font-bold text-white text-2xl uppercase font-head tracking-wide">{item.name}</h3><div className="bg-premium text-black px-3 py-1 font-black text-xl border-2 border-white">{stickers.length} STOCK</div></div><div className="flex gap-2 mb-4"><input type="number" placeholder="#" className="flex-1 search-industrial px-4 py-2 font-black text-xl" value={inputs[item.id] || ""} onChange={(e) => handleInputChange(item.id, e.target.value)} /><button onClick={() => handleAddSticker(item)} className="bg-premium hover:bg-white text-black border-2 border-white px-6 py-2 font-black text-xl uppercase shadow-[4px_4px_0px_0px_rgba(255,255,255,0.5)] active:translate-y-1 active:shadow-none transition-all">+ ADD</button></div><div className="flex flex-wrap gap-2">{stickers.length === 0 && <span className="text-sm text-gray-500 font-bold uppercase">NO TAGS LOADED</span>}{stickers.map((sticker, idx) => (<button key={idx} onClick={() => handleRemoveSticker(item, sticker)} className="flex items-center gap-2 bg-[#222] border-2 border-white px-3 py-1 hover:bg-red-600 hover:border-red-600 transition-colors group"><span className="font-mono font-bold text-white text-lg">{sticker}</span><span className="text-xs text-white opacity-0 group-hover:opacity-100 font-bold ml-2">DEL</span></button>))}</div></div>); })}</div> </div> );
        };

        const LinkModal = ({ barcode, data, onLink, onClose }) => {
            const [search, setSearch] = useState("");
            const filtered = data.map(c => ({ ...c, items: c.items.filter(i => i.name.toLowerCase().includes(search.toLowerCase())) })).filter(c => c.items.length > 0);
            return ( <div className="fixed inset-0 z-50 flex flex-col animate-in bg-black/95 backdrop-blur-sm"> <div className="bg-white p-4 border-b-4 border-black flex flex-col gap-4"><div className="flex justify-between items-center"><h2 className="text-3xl font-black text-black uppercase" style={{fontFamily: 'Anton'}}>UNKNOWN CODE</h2><button onClick={onClose} className="text-black font-bold border-2 border-black px-4 py-1 hover:bg-black hover:text-white uppercase">CANCEL</button></div><div className="bg-black text-white p-4 text-center font-mono text-2xl font-bold tracking-widest border-2 border-black">{barcode}</div></div> <div className="p-4 bg-black border-b border-[#333]"><input type="text" placeholder="SEARCH PRODUCT TO LINK..." className="w-full search-industrial p-4 text-xl uppercase" value={search} onChange={e=>setSearch(e.target.value)} autoFocus /></div> <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-black">{filtered.map(cat => (<div key={cat.category}><h3 className="text-white font-black text-xl uppercase mb-2 border-b-2 border-premium inline-block pr-4">{cat.category}</h3>{cat.items.map(item => (<button key={item.id} onClick={() => onLink(item)} className="w-full text-left bg-[#111] border-2 border-[#333] p-4 mb-2 flex justify-between items-center hover:bg-white hover:text-black hover:border-white transition-colors duration-0 group"><span className="font-bold text-lg uppercase">{item.name}</span><span className="text-sm font-bold bg-black text-white px-2 py-1 group-hover:bg-black group-hover:text-white">LINK</span></button>))}</div>))}</div> </div> );
        };

        const ReviewModal = ({ onClose, data, onUpdate }) => {
            const mainLocs = [ { id: 'bar1', label: 'BAR 1', bg: 'bg-premium', text: 'text-black', border: 'border-white' }, { id: 'bar2', label: 'BAR 2', bg: 'bg-beers', text: 'text-black', border: 'border-white' }, { id: 'bodega', label: 'STORAGE', bg: 'bg-wells', text: 'text-white', border: 'border-white' }, { id: 'barroluco', label: 'BARROLUCO', bg: 'bg-wines', text: 'text-white', border: 'border-white' } ];
            return ( <div className="fixed inset-0 z-50 flex flex-col animate-in bg-black"> <div className="bg-white p-4 border-b-4 border-black flex justify-between items-center shrink-0"><h2 className="text-3xl font-black text-black uppercase" style={{fontFamily: 'Anton'}}>COUNT CHECK</h2><button onClick={onClose} className="bg-black text-white px-6 py-2 font-bold uppercase border-2 border-black hover:bg-white hover:text-black hover:border-black transition-colors">CLOSE</button></div> <div className="flex-1 overflow-y-auto p-4 space-y-8 bg-black"> {mainLocs.map(main => { const subZones = ZONES_CONFIG[main.id] || []; const mainTotal = data.reduce((acc, cat) => acc + cat.items.reduce((iAcc, item) => iAcc + (parseFloat(item[main.id])||0), 0), 0); const directItems = data.flatMap(cat => cat.items.filter(i => (parseFloat(i[main.id])||0) > 0)).map(i => ({...i, val: parseFloat(i[main.id])})); if (mainTotal === 0) return null; return ( <div key={main.id} className="space-y-0 relative border-4 border-white"> <div className={`sticky top-0 z-10 py-2 px-4 flex justify-between items-center ${main.bg} border-b-4 border-white`}> <h3 className={`font-black text-3xl uppercase tracking-tight ${main.text}`} style={{fontFamily: 'Anton'}}>{main.label}</h3> <span className="bg-black text-white font-mono text-xl font-bold px-3 py-1 border-2 border-white">TOTAL: {mainTotal}</span> </div> {subZones.map(zone => { const zoneItems = data.flatMap(cat => cat.items) .filter(i => (parseFloat(i[zone.id])||0) > 0) .map(i => ({...i, val: parseFloat(i[zone.id])})) .sort((a, b) => (b.last_updated || 0) - (a.last_updated || 0)); if (zoneItems.length === 0) return null; return ( <div key={zone.id} className="bg-[#111] p-2 border-b-2 border-[#333]"> <div className="text-sm font-bold text-gray-400 mb-2 pl-2 uppercase tracking-wider border-l-4 border-gray-600 pl-2">{zone.label}</div> <div className="grid gap-1"> {zoneItems.map(item => { const isMulti = (zone.id === 'bar1_cooler' && (item.name.toLowerCase().includes('corona') || item.name.toLowerCase().includes('modelo'))); return ( <div key={item.id} className={`bg-black border border-[#333] p-2 flex justify-between items-center`}> <span className="font-bold text-white text-lg uppercase truncate pr-2 w-full">{item.name}</span> {isMulti ? ( <div className="flex gap-1">{(item.breakdown_bar1_cooler || [0,0,0,0]).map((s,i)=><div key={i} className="bg-gray-800 text-white w-8 text-center font-mono text-sm border border-gray-600">{s}</div>)}</div> ) : ( <input type="number" value={item.val} onChange={(e) => { const val = parseFloat(e.target.value) || 0; let newTotal = val; subZones.forEach(z => { if(z.id !== zone.id) newTotal += (parseFloat(item[z.id])||0); }); onUpdate(item.id, { [zone.id]: val, [main.id]: newTotal }); }} className="w-16 bg-[#333] border-2 border-white text-right text-white font-mono font-bold text-xl px-2 focus:bg-premium focus:text-black outline-none"/> )} </div> ); })} </div> </div> ); })} {!subZones.length && directItems.map(item => (<div key={item.id} className="bg-black border-b border-[#333] p-3 flex justify-between items-center"><span className="font-bold text-white text-lg uppercase">{item.name}</span><input type="number" value={item.val} onChange={(e) => onUpdate(item.id, main.id, parseFloat(e.target.value)||0)} className="w-16 bg-[#333] border-2 border-white text-right text-white font-mono font-bold text-xl px-2 focus:bg-premium focus:text-black outline-none"/></div>))} </div> ); })} </div> </div> );
        };

        const BottleCalibrationModal = ({ item, onClose, onSave }) => {
            const [full, setFull] = useState(item.weight_full || ""); const [empty, setEmpty] = useState(item.weight_empty || "");
            return ( <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center p-4 animate-in bg-black/95"> <div className="bg-black w-full max-w-sm border-4 border-white p-6 shadow-[10px_10px_0px_0px_#fff]"> <div className="flex justify-between items-center mb-8"><h2 className="text-3xl font-black text-white uppercase" style={{fontFamily: 'Anton'}}>SCALE SETUP</h2><button onClick={onClose} className="text-white font-bold hover:text-gray-400 uppercase">CANCEL</button></div> <div className="text-center mb-8"><h3 className="text-2xl font-bold text-white mb-1 uppercase tracking-wider">{item.name}</h3><p className="text-sm text-gray-400 font-mono uppercase">GRAMS ONLY</p></div> <div className="space-y-6 mb-8"> <div><label className="block text-sm font-bold text-white uppercase mb-1">FULL BOTTLE</label><div className="flex items-center gap-2"><input type="number" placeholder="1300" className="w-full search-industrial p-4 text-2xl font-black" value={full} onChange={e=>setFull(e.target.value)} /><span className="text-white font-bold font-mono text-xl">g</span></div></div> <div><label className="block text-sm font-bold text-white uppercase mb-1">EMPTY BOTTLE</label><div className="flex items-center gap-2"><input type="number" placeholder="500" className="w-full search-industrial p-4 text-2xl font-black" value={empty} onChange={e=>setEmpty(e.target.value)} /><span className="text-white font-bold font-mono text-xl">g</span></div></div> </div> <button onClick={() => { if(full && empty) onSave(item.id, full, empty); }} className="w-full bg-white hover:bg-gray-200 text-black font-black py-4 text-xl border-2 border-black shadow-[4px_4px_0px_0px_rgba(100,100,100,1)] active:translate-y-1 active:shadow-none transition-all uppercase tracking-widest">SAVE DATA</button> </div> </div> );
        };

        const QuickEditModal = ({ item, onClose, onContinue, onUpdate, initialLocation, initialSubZone, onOpenCalibration, scaleWeight, isScaleConnected, onConnectScale }) => {
            const [value, setValue] = useState(0); const [manualGrams, setManualGrams] = useState("");
            const zones = ZONES_CONFIG[initialLocation] || []; const subZoneId = initialSubZone || (zones[0]?.id); const subZoneLabel = zones.find(z => z.id === subZoneId)?.label; const targetField = zones.length > 0 ? subZoneId : initialLocation; const historyKey = `last_${targetField}`; const historyVal = item[historyKey] !== undefined ? item[historyKey] : '-';
            const isOpenZone = ['bar1_shelf_open', 'bar1_well_1', 'bar1_well_2'].includes(initialSubZone) || initialLocation === 'barroluco';
            const isCaseZone = ['bar1_reaching', 'bar1_shelf_full', 'bodega_shelves'].includes(initialSubZone) || initialLocation === 'purchases';
            const isMultiCount = (subZoneId === 'bar1_cooler' && (item.name.toLowerCase().includes('corona') || item.name.toLowerCase().includes('modelo')));
            const isSmallGroup = !isOpenZone && !isMultiCount;
            const [slots, setSlots] = useState(() => { if(isMultiCount && item.breakdown_bar1_cooler) return item.breakdown_bar1_cooler; return [0, 0, 0, 0]; });
            const [startVal] = useState(() => parseFloat(item[targetField]) || 0); const [scaleAddedValue, setScaleAddedValue] = useState(0);
            
            useEffect(() => { if(!isMultiCount) setValue(parseFloat(item[targetField]) || 0); else { const sum = slots.reduce((a, b) => a + (parseFloat(b)||0), 0); setValue(sum); } }, [item, targetField, isMultiCount, slots]);
            useEffect(() => { if (isOpenZone && scaleWeight !== null && scaleWeight !== undefined && scaleWeight !== "") { setManualGrams(scaleWeight); performCalculation(scaleWeight, true); } }, [scaleWeight]);
            const updateValue = (next) => { setValue(next); if (zones.length > 0) { let newTotal = 0; zones.forEach(z => { if (z.id === subZoneId) newTotal += next; else newTotal += (parseFloat(item[z.id]) || 0); }); onUpdate(item.id, { [subZoneId]: next, [initialLocation]: newTotal }); } else { onUpdate(item.id, initialLocation, next); } };
            const handleSlotChange = (idx, val) => { const newSlots = [...slots]; newSlots[idx] = val === "" ? 0 : parseFloat(val); setSlots(newSlots); const newSum = newSlots.reduce((a, b) => a + b, 0); setValue(newSum); let newTotal = 0; zones.forEach(z => { if (z.id === subZoneId) newTotal += newSum; else newTotal += (parseFloat(item[z.id]) || 0); }); onUpdate(item.id, { [subZoneId]: newSum, [initialLocation]: newTotal, breakdown_bar1_cooler: newSlots }); };
            const handleDelta = (delta) => { const next = Math.max(0, Math.round((value + delta) * 100) / 100); updateValue(next); if(delta>0) playSound('add'); else playSound('sub'); };
            const performCalculation = (gramsInput, isAuto = false) => { const grams = parseFloat(gramsInput); if (isNaN(grams) && gramsInput !== "") return; const full = parseFloat(item.weight_full); const empty = parseFloat(item.weight_empty); if (!full || !empty) return; const netLiquid = full - empty; const currentLiquid = grams - empty; let calculatedUnits = currentLiquid / netLiquid; if (calculatedUnits < 0) calculatedUnits = 0; const currentBottleValue = Math.round(calculatedUnits * 100) / 100; setScaleAddedValue(currentBottleValue); if (isAuto && currentBottleValue === 0 && startVal > 0) { return; } let finalVal; if (isAuto) { finalVal = startVal + currentBottleValue; } else { finalVal = currentBottleValue; } finalVal = Math.round(finalVal * 100) / 100; updateValue(finalVal); };
            const handleAddScaleToTotal = () => { const next = Math.max(0, Math.round((value + scaleAddedValue) * 100) / 100); updateValue(next); playSound('add'); };
            const handleManualInput = (val) => { setManualGrams(val); performCalculation(val, false); };
            const sessionDiff = Math.round((value - startVal) * 100) / 100; const diffSign = sessionDiff > 0 ? "+" : ""; const diffColor = sessionDiff > 0 ? "text-[#00dcd2]" : sessionDiff < 0 ? "text-red-500" : "text-gray-600";

            return ( <div className="fixed inset-0 z-50 flex flex-col items-center justify-center p-2 animate-in bg-black"> <div className="w-full max-w-md flex flex-col h-[95vh] border-4 border-white bg-black relative shadow-[10px_10px_0px_0px_rgba(50,50,50,1)]"> <div className="p-4 border-b-4 border-white flex justify-between items-center bg-black"> <div className="overflow-hidden"> <h2 className="text-3xl font-black text-white leading-none tracking-tight uppercase truncate" style={{fontFamily: 'Anton'}}>{item.name}</h2> <div className="text-sm text-gray-400 font-bold mt-1 uppercase tracking-wider">{initialLocation} {subZoneLabel ? `// ${subZoneLabel}` : ''}</div> </div> <button onClick={onClose} className="bg-white hover:bg-gray-200 text-black h-12 w-12 flex items-center justify-center font-black text-2xl border-2 border-black transition-transform active:translate-y-1">X</button> </div> <div className="flex-1 flex flex-col items-center justify-center relative bg-black"> <div className={`text-[9rem] font-black leading-none mb-2 select-none ${diffColor}`} style={{fontFamily: 'Anton'}}>{diffSign}{sessionDiff}</div> <div className="flex items-center gap-4 mb-8 w-full px-6"> <div className="flex-1 border-4 border-white bg-black p-2 flex flex-col items-center justify-center"> <span className="text-xs uppercase font-black text-white tracking-widest bg-gray-800 px-2 mb-1">CURRENT</span> <span className="text-white text-5xl font-black" style={{fontFamily: 'Anton'}}>{value}</span> {scaleAddedValue > 0 && isOpenZone && ( <div className="text-xs text-[#00dcd2] font-black mt-1 uppercase"> [BASE: {startVal} + {scaleAddedValue}] </div> )} </div> <div className="flex-1 border-4 border-gray-700 bg-black p-2 flex flex-col items-center justify-center"> <span className="text-xs uppercase font-black text-gray-500 tracking-widest bg-gray-900 px-2 mb-1">PREVIOUS</span> <span className="text-gray-500 text-5xl font-black" style={{fontFamily: 'Anton'}}>{historyVal}</span> </div> </div> {isMultiCount ? ( <div className="w-full px-6 max-w-sm"> <div className="text-center text-sm text-white font-black mb-2 uppercase border-b-2 border-white inline-block mx-auto">MULTI-SLOT CONFIG</div> <div className="grid grid-cols-2 gap-4 mt-2">{slots.map((sVal, idx) => (<div key={idx} className="relative"><div className="absolute top-1 left-2 text-[10px] text-black font-black bg-white px-1 z-10">S{idx+1}</div><input type="number" className="w-full bg-[#bbbbbb] border-4 border-white px-2 py-4 pt-6 text-black font-black text-4xl text-center focus:bg-white outline-none" style={{fontFamily: 'Anton'}} value={sVal || ""} placeholder="0" onChange={(e) => handleSlotChange(idx, e.target.value)} /></div>))}</div> </div> ) : ( <> {isOpenZone && ( <div className="w-full px-6 max-w-sm mb-6"> {(!item.weight_full || !item.weight_empty) ? ( <button onClick={() => onOpenCalibration(item)} className="w-full py-4 bg-yellow-600 border-4 border-white text-white font-black text-xl flex items-center justify-center gap-2 hover:bg-yellow-500 uppercase tracking-wider"><Icons.Wrench /> CALIBRATE</button> ) : ( <div className="flex flex-col gap-2"> <div className="flex justify-between items-end px-1"> <span className="text-xs text-white font-black uppercase tracking-[0.2em]">DIGITAL SCALE</span> <button onClick={onConnectScale} disabled={isScaleConnected} className={`text-xs font-black px-2 py-1 border-2 uppercase tracking-wide ${isScaleConnected ? 'bg-[#00dcd2] text-black border-[#00dcd2]' : 'bg-black text-white border-white hover:bg-white hover:text-black'}`}>{isScaleConnected ? "LINKED" : "CONNECT BT"}</button> </div> <div className="flex gap-2"> <div className="relative w-full"> <input type="number" placeholder="0" className={`w-full bg-[#bbbbbb] border-4 px-2 py-3 text-black font-black text-center text-4xl outline-none placeholder-gray-600 ${isScaleConnected ? 'border-[#00dcd2]' : 'border-white'}`} style={{fontFamily: 'Anton'}} value={manualGrams} onChange={e=>handleManualInput(e.target.value)} /> <div className="absolute right-3 top-5 text-black font-black text-sm">g</div> {manualGrams && <div className="absolute left-2 top-2 bg-[#00dcd2] text-black text-[10px] font-black px-1 uppercase">AUTO-CALC</div>} </div> {value > 0 && scaleAddedValue > 0 && ( <button onClick={handleAddScaleToTotal} className="bg-[#00dcd2] hover:bg-white text-black border-4 border-white px-4 flex flex-col items-center justify-center min-w-[80px] active:translate-y-1"> <span className="text-[10px] font-black uppercase">ADD</span> <span className="text-2xl font-black" style={{fontFamily: 'Anton'}}>+{scaleAddedValue}</span> </button> )} </div> </div> )} </div> )} <div className="grid grid-cols-2 gap-4 w-full px-6 max-w-sm mb-4"> <div className="flex flex-col gap-2 items-end"> {isCaseZone && <button onClick={()=>handleDelta(-24)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg uppercase transition-colors duration-0 active:translate-y-1">- CASE</button>} {isSmallGroup ? ( <> <button onClick={()=>handleDelta(-12)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">- 12</button> <button onClick={()=>handleDelta(-6)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">- 6</button> <button onClick={()=>handleDelta(-3)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">- 3</button> </> ) : ( <> {!isOpenZone && <button onClick={()=>handleDelta(-24)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">- 24</button>} {!isOpenZone && <button onClick={()=>handleDelta(-12)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">- 12</button>} {!isOpenZone && <button onClick={()=>handleDelta(-6)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">- 6</button>} </> )} <button onClick={()=>handleDelta(-1)} className="w-full h-16 bg-[#111] hover:bg-red-600 text-white border-4 border-white font-black text-4xl active:translate-y-1 shadow-md" style={{fontFamily: 'Anton'}}>-1</button> </div> <div className="flex flex-col gap-2 items-start"> {isCaseZone && <button onClick={()=>handleDelta(24)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg uppercase transition-colors duration-0 active:translate-y-1">+ CASE</button>} {isSmallGroup ? ( <> <button onClick={()=>handleDelta(12)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">+ 12</button> <button onClick={()=>handleDelta(6)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">+ 6</button> <button onClick={()=>handleDelta(3)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">+ 3</button> </> ) : ( <> {!isOpenZone && <button onClick={()=>handleDelta(24)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">+ 24</button>} {!isOpenZone && <button onClick={()=>handleDelta(12)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">+ 12</button>} {!isOpenZone && <button onClick={()=>handleDelta(6)} className="w-full h-12 bg-black hover:bg-white hover:text-black text-white border-2 border-white font-black text-lg transition-colors duration-0 active:translate-y-1">+ 6</button>} </> )} <button onClick={()=>handleDelta(1)} className="w-full h-16 bg-[#111] hover:bg-[#00dcd2] hover:text-black text-white border-4 border-white font-black text-4xl active:translate-y-1 shadow-md" style={{fontFamily: 'Anton'}}>+1</button> </div> </div> {isOpenZone && ( <div className="grid grid-cols-2 gap-4 w-full px-6 max-w-sm relative z-10"> <button onClick={()=>handleDelta(-0.1)} className="bg-black hover:bg-gray-800 text-gray-300 h-12 border-2 border-gray-500 font-bold text-lg active:translate-y-1">- 0.1</button> <button onClick={()=>handleDelta(0.1)} className="bg-black hover:bg-gray-800 text-gray-300 h-12 border-2 border-gray-500 font-bold text-lg active:translate-y-1">+ 0.1</button> </div> )} </> )} </div> <button onClick={onContinue} className="m-4 bg-[#00dcd2] hover:bg-white text-black font-black text-2xl h-16 border-4 border-white shadow-[0_4px_0_0_rgba(255,255,255,0.5)] active:shadow-none active:translate-y-1 transition-all flex items-center justify-center gap-3 tracking-widest uppercase">DONE</button> </div> </div> );
        };
        function App() {
            const [auth, setAuth] = useState(false); const [data, setData] = useState([]); const [loc, setLoc] = useState('bar1'); const [subZone, setSubZone] = useState(null); const [scanning, setScanning] = useState(false); const [editItem, setEditItem] = useState(null); const [showLoc, setShowLoc] = useState(false); const [showMenu, setShowMenu] = useState(false); const [showCheck, setShowCheck] = useState(false); const [showPremium, setShowPremium] = useState(false); const [showPurchases, setShowPurchases] = useState(false); const [search, setSearch] = useState(""); const [status, setStatus] = useState("Connecting..."); const [pendingBarcode, setPendingBarcode] = useState(null); const [calibratingItem, setCalibratingItem] = useState(null); const [isOnline, setIsOnline] = useState(navigator.onLine); const [scaleWeight, setScaleWeight] = useState(""); const [isScaleConnected, setIsScaleConnected] = useState(false); const [expandedCats, setExpandedCats] = useState({});
            
            const toggleCategory = (catName) => { setExpandedCats(prev => ({ ...prev, [catName]: !prev[catName] })); };
            useEffect(() => { const handleStatus = () => setIsOnline(navigator.onLine); window.addEventListener('online', handleStatus); window.addEventListener('offline', handleStatus); return () => { window.removeEventListener('online', handleStatus); window.removeEventListener('offline', handleStatus); }; }, []);
            useEffect(() => { const app = window.fb.initializeApp(FIREBASE_CONFIG); const auth = window.fb.getAuth(app); const db = window.fb.getFirestore(app); window.fb.signInAnonymously(auth); window.fb.onAuthStateChanged(auth, (u) => { if (u) { setStatus("ONLINE"); const path = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/public/data/inventory` : 'inventory'; window.fb.onSnapshot(window.fb.doc(db, path, 'master'), (s) => { if(s.exists()) setData(s.data().items); }); } else setStatus("OFFLINE"); }); }, []);
            
            const handleConnectScale = async () => { try { const device = await navigator.bluetooth.requestDevice({ filters: [{ namePrefix: 'Etekcity' }], optionalServices: [0xFFF0] }); const server = await device.gatt.connect(); const service = await server.getPrimaryService(0xFFF0); const characteristic = await service.getCharacteristic(0xFFF1); await characteristic.startNotifications(); setIsScaleConnected(true); playSound('connect'); characteristic.addEventListener('characteristicvaluechanged', (event) => { const value = event.target.value; if (value.byteLength < 12) return; const weightRaw = value.getUint16(11, true); const finalWeight = (weightRaw / 10).toFixed(1); setScaleWeight(finalWeight); }); device.addEventListener('gattserverdisconnected', () => { setIsScaleConnected(false); playSound('error'); }); } catch (error) { console.error("Scale Error:", error); alert("Bluetooth Error: " + error.message); setIsScaleConnected(false); } };
            const handleUpdate = (id, fieldOrObj, val) => { const timestamp = Date.now(); const newData = data.map(cat => ({ ...cat, items: cat.items.map(i => { if(i.id === id) { if(typeof fieldOrObj === 'object') return {...i, ...fieldOrObj, last_updated: timestamp}; return {...i, [fieldOrObj]: val, last_updated: timestamp}; } return i; }) })); setData(newData); const db = window.fb.getFirestore(); const path = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/public/data/inventory` : 'inventory'; window.fb.setDoc(window.fb.doc(db, path, 'master'), { items: newData }).catch(console.error); };
            const handleLocalReset = () => { if(!confirm("âš  RESET DATA?\n\nZero out all counts?")) return; const resetData = data.map(cat => ({ ...cat, items: cat.items.map(i => { const resetItem = { ...i }; Object.values(ZONES_CONFIG).forEach(zoneArr => { zoneArr.forEach(z => { resetItem[`last_${z.id}`] = parseFloat(i[z.id]) || 0; resetItem[z.id] = 0; }); }); ['bar1', 'bar2', 'bodega', 'barroluco', 'purchases'].forEach(k => { resetItem[`last_${k}`] = parseFloat(i[k]) || 0; resetItem[k] = 0; }); return resetItem; }) })); setData(resetData); const db = window.fb.getFirestore(); const path = typeof __app_id !== 'undefined' ? `artifacts/${__app_id}/public/data/inventory` : 'inventory'; window.fb.setDoc(window.fb.doc(db, path, 'master'), { items: resetData }).catch(console.error); playSound('sub'); setShowMenu(false); };
            const handleBackup = () => { const blob = new Blob([JSON.stringify(data)], { type: "application/json" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `Scanner_Backup_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleScan = (txt) => { let found = null; for(const c of data) { const m = c.items.find(i => (i.barcode && i.barcode.includes(txt)) || (i.barcode_case && i.barcode_case === txt)); if(m){found=m; break;} } if(found) { setEditItem(found); setScanning(false); playSound('success'); } else { playSound('error'); setPendingBarcode(txt); setScanning(false); } };
            const handleLinkBarcode = (item) => { const currentCodes = item.barcode ? item.barcode : ""; const newCodes = currentCodes ? `${currentCodes},${pendingBarcode}` : pendingBarcode; handleUpdate(item.id, 'barcode', newCodes); setPendingBarcode(null); setEditItem(item); playSound('success'); };
            const updateItemStickers = (itemId, newStickersArray) => handleUpdate(itemId, 'sticker_ids', newStickersArray);
            const saveBottleWeights = (itemId, full, empty) => { handleUpdate(itemId, { weight_full: full, weight_empty: empty }); setCalibratingItem(null); playSound('success'); };
            const filteredData = useMemo(() => { const term = search.toLowerCase(); return data.map(c => ({ ...c, items: c.items.filter(i => i.name.toLowerCase().includes(term)) })).filter(c => c.items.length > 0); }, [data, search]);
            const getCatColorClass = (catName) => { const lower = catName.toLowerCase(); if(lower.includes('premium')) return 'bg-premium'; if(lower.includes('wells')) return 'bg-wells'; if(lower.includes('seltzer')) return 'bg-seltzer'; if(lower.includes('beer')) return 'bg-beers'; if(lower.includes('wine')) return 'bg-wines'; if(lower.includes('non')) return 'bg-nonalc'; return 'bg-gray-800'; };

            if (!auth) return <LoginScreen onLogin={() => setAuth(true)} />;

            return (
                <div className="pb-40 relative min-h-screen bg-black text-white">
                    {/* --- ENCABEZADO FIJO (STICKY) --- */}
                    <div className="sticky-header-industrial">
                        {/* 1. Titulo y Botones Superiores */}
                        <div className="flex justify-between items-start p-4">
                            <div>
                                <h1 className="text-5xl text-white uppercase tracking-tight leading-none" style={{fontFamily: 'Anton'}}>SCANNER PRO 6.0</h1>
                                <div className="flex items-center gap-2 mt-2">
                                    <div className={`w-3 h-3 ${isOnline ? 'bg-green-500' : 'bg-red-500'} border border-white`}></div>
                                    <span className="text-xs text-white font-mono uppercase tracking-widest">{isOnline ? 'SYSTEM ONLINE' : 'OFFLINE MODE'}</span>
                                </div>
                            </div>
                            <div className="flex flex-col gap-2">
                                <button onClick={() => setShowCheck(true)} className="bg-black border-2 border-white text-white p-2 hover:bg-white hover:text-black transition-colors duration-0"><Icons.List className="h-6 w-6" /></button>
                                <button onClick={() => setShowMenu(!showMenu)} className="bg-black border-2 border-white text-white p-2 hover:bg-white hover:text-black transition-colors duration-0"><Icons.Settings className="h-6 w-6" /></button>
                            </div>
                        </div>

                        {/* 2. Selector de Zona */}
                        <div className="px-4 pb-2">
                            <button onClick={() => setShowLoc(true)} className="w-full bg-black border-4 border-white p-4 group active:translate-y-1 transition-transform relative">
                                <div className="text-[10px] text-gray-400 uppercase font-black tracking-[0.2em] mb-1 text-left">CURRENT SECTOR</div>
                                <div className="flex justify-between items-center">
                                    <div className="text-white font-black text-4xl uppercase tracking-wide leading-none" style={{fontFamily: 'Anton'}}>
                                        {ZONES_CONFIG[loc] ? (ZONES_CONFIG[loc].find(z=>z.id===subZone)?.label || 'SELECT ZONE') : loc === 'purchases' ? 'PURCHASES' : loc === 'barroluco' ? 'BARROLUCO' : 'MAIN AREA'}
                                    </div>
                                    <Icons.ChevronDown className="text-white w-8 h-8"/>
                                </div>
                            </button>
                        </div>

                        {/* 3. Barra de BÃºsqueda */}
                        <div className="px-4 pb-4">
                            <div className="relative">
                                <input type="text" placeholder="Search database..." className="w-full search-industrial py-3 px-4 text-xl uppercase placeholder-gray-600 focus:outline-none focus:bg-white focus:border-white transition-colors" value={search} onChange={e=>setSearch(e.target.value)} />
                                <Icons.Search className="absolute right-4 top-3.5 text-black pointer-events-none" />
                            </div>
                        </div>
                    </div>
                    {/* --- FIN DEL ENCABEZADO FIJO --- */}

                    {/* MenÃº Dropdown (Absoluto sobre el contenido) */}
                    {showMenu && (<><div className="menu-backdrop" onClick={() => setShowMenu(false)}></div><div className="absolute top-24 right-4 bg-black border-4 border-white p-4 z-50 flex flex-col gap-2 w-64 shadow-[10px_10px_0px_0px_#333]"><button onClick={() => { setShowPurchases(true); setShowMenu(false); }} className="flex items-center gap-3 p-3 bg-[#111] hover:bg-white hover:text-black text-white font-bold uppercase tracking-wide border border-[#333] transition-colors duration-0"><Icons.Package /> INBOUND LOG</button><button onClick={() => { setShowPremium(true); setShowMenu(false); }} className="flex items-center gap-3 p-3 bg-[#111] hover:bg-premium hover:text-black text-white font-bold uppercase tracking-wide border border-[#333] transition-colors duration-0"><Icons.Star /> BOTTLE CTRL</button><button onClick={() => { handleBackup(); setShowMenu(false); }} className="flex items-center gap-3 p-3 bg-[#111] hover:bg-white hover:text-black text-white font-bold uppercase tracking-wide border border-[#333] transition-colors duration-0"><Icons.Save /> BACKUP DATA</button><div className="h-1 bg-white my-1"></div><button onClick={handleLocalReset} className="flex items-center gap-3 p-3 bg-red-900 hover:bg-red-600 text-white font-bold uppercase tracking-wide border border-red-500 transition-colors duration-0"><Icons.Refresh /> FACTORY RESET</button></div></>)}

                    {/* Contenido Scrollable */}
                    <div className="px-4 pt-4 space-y-4">
                        {filteredData.map(cat => {
                            const isExpanded = search.length > 0 || expandedCats[cat.category];
                            const catColorClass = getCatColorClass(cat.category);
                            return (
                                <div key={cat.category} className="mb-2">
                                    <button onClick={() => toggleCategory(cat.category)} className={`cat-block ${catColorClass} hover:brightness-110 active:brightness-90 transition-all duration-0`}>
                                        <div className="flex justify-between items-center w-full"><span>{cat.category}</span>{isExpanded ? <span className="text-3xl">-</span> : <span className="text-3xl">+</span>}</div>
                                        {cat.category.toLowerCase().includes('premium') && <div className="cat-sub">(TEQUILA/WHISKY)</div>}
                                    </button>
                                    {isExpanded && (<div className="border-x-4 border-b-4 border-white bg-black p-2 space-y-2">{cat.items.map(item => { const qty = parseFloat(item[subZone || loc]) || 0; const hasQty = qty > 0; return (<div key={item.id} onClick={() => setEditItem(item)} className={`p-4 flex justify-between items-center cursor-pointer border-2 transition-all duration-0 ${hasQty ? "bg-white border-white" : "bg-[#111] border-[#333] hover:border-white"}`}><div className={`font-bold text-lg uppercase ${hasQty ? 'text-black' : 'text-white'}`}>{item.name}</div>{hasQty && <div className="bg-black text-white font-black font-mono text-xl px-3 py-1 border-2 border-black">{qty}</div>}</div>); })}</div>)}
                                </div>
                            );
                        })}
                    </div>

                    <button onClick={() => setScanning(true)} className="fixed bottom-8 left-1/2 -translate-x-1/2 h-20 w-20 bg-[#00dcd2] text-black rounded-full shadow-[0_0_0_4px_rgba(0,0,0,1),0_0_0_8px_rgba(255,255,255,1)] flex items-center justify-center z-30 active:scale-90 transition-transform"><div className="border-4 border-black p-1"><Icons.Scan className="w-8 h-8" /></div></button>

                    {pendingBarcode && <LinkModal barcode={pendingBarcode} data={data} onLink={handleLinkBarcode} onClose={() => { setPendingBarcode(null); setTimeout(() => setScanning(true), 300); }} />}
                    {showPremium && <PremiumControlModal onClose={() => setShowPremium(false)} data={data} onUpdateStickers={updateItemStickers} />}
                    {showPurchases && <PurchasesLogModal onClose={() => setShowPurchases(false)} data={data} />}
                    {showCheck && <ReviewModal onClose={() => setShowCheck(false)} data={data} onUpdate={handleUpdate} />}
                    {showLoc && <LocationModal onClose={() => setShowLoc(false)} onSelect={(l, s) => { setLoc(l); setSubZone(s); setShowLoc(false); }} />}
                    {scanning && <ScannerModal onScan={handleScan} onClose={() => setScanning(false)} />}
                    {calibratingItem && <BottleCalibrationModal item={calibratingItem} onClose={()=>setCalibratingItem(null)} onSave={saveBottleWeights} />}
                    {editItem && (<QuickEditModal item={editItem} initialLocation={loc} initialSubZone={subZone} onClose={() => setEditItem(null)} onOpenCalibration={setCalibratingItem} onContinue={() => { setEditItem(null); setTimeout(() => setScanning(true), 300); }} onUpdate={handleUpdate} scaleWeight={scaleWeight} isScaleConnected={isScaleConnected} onConnectScale={handleConnectScale} />)}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
